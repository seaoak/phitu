<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>[PoC] Partial updating with Vue.js</title>
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
  <script src="main.js"></script>
  <link rel="stylesheet" href="main.css">
  <style>
    nav {
      position: sticky;
      top: 0;
      background: #eee;
    }
  </style>
</head>
<body>

  <nav>
    <input id="GlobalSwitch" type="checkbox">
    <label for="GlobalSwitch">On</label>
    <select id="IntervalSelect">
      <option>1sec</option>
      <option>3sec</option>
      <option selected>5sec</option>
      <option>8sec</option>
      <option>10sec</option>
      <option>15sec</option>
      <option>20sec</option>
      <option>30sec</option>
      <option>60sec</option>
    </select>
    <select id="MethodSelect">
      <option selected>removeChild()/insertBefore()</option>
      <option>replaceChild()</option>
      <option>appendChild()</option>
    </select>
    <input id="CSSAssistSwitch" type="checkbox">
    <label for="CSSAssistSwitch">with <code>style=&quot;display:none&quot;</code></label>
    <select id="NodeTypeSwitch">
      <option selected>&lt;p&gt;</option>
      <option>&lt;img&gt;</option>
      <option>&lt;li&gt;</option>
    </select>
    <select id="ElementSizeSwitch">
      <option selected>Flexible</option>
      <option>Fixed</option>
    </select>
    <input id="UrlHashSwitch" type="checkbox">
    <label for="UrlHashSwitch">with URL Hash</label>
  </nav>

  <div class="article-inner">
    <header class="article-header">
      <h1 class="article-title" itemprop="name">
        Hexo server をよりセキュアに
      </h1>
    </header>
    <div class="article-entry" itemprop="articleBody">

<p>Hexo server への直接アクセスを禁止して、Web サーバ H2O を「SSL/TLS あり Basic 認証ありの reverse proxy」として動かして、その H2O 経由で Hexo server にアクセスするようにします。</p>

<h2 id="まえがき"><a href="#まえがき" class="headerlink" title="まえがき"></a>まえがき</h2>

<p>静的サイトジェネレータ (Static Site Generator: SSG) のひとつである Hexo には、”Hexo server” という便利な機能があります。Hexo で構築しているブログを更新するとき、Web サーバに deploy せずにプレビューできる機能です。</p>
<ul>
<li>Hexo 公式サイト<br><a href="https://hexo.io" target="_blank" rel="external">https://hexo.io</a></li>
<li>Server | Hexo<br><a href="https://hexo.io/docs/server.html" target="_blank" rel="external">https://hexo.io/docs/server.html</a></li>
</ul>
<p>コマンドラインで “<code>hexo server -p 8888</code>“ とか実行するだけで Hexo 内蔵の HTTP サーバ機能が起動します。手元の Web ブラウザでポート番号を指定してアクセスすれば、更新後のブログのプレビューが見られます。ブログの原稿（Markdown ファイル）を更新すると、Hexo server がそれをリアルタイムに検知して自動的にコンテンツに反映してくれるので、ブラウザでリロードするだけで結果をチェックできます。</p>
<p>Hexo server の難点は、アクセス制限がかけられないことです。クラウド上の公開サーバで実行すると、インターネットに向けてコンテンツが公開されてしまうのです。プレビュー用なのに。もちろん、ポート番号を誰も使ってなさそうな大きな番号にするとか、アクセス可能な IP アドレスを iptables で制限するとか、緩和策はあります。でも、なんかイマイチ。そもそも、Hexo server は本格的な Web サーバとして作られているわけではないので、セキュリティ的にも不安があります（ちゃんと調べてないので実は安全なのかもしれませんが）。</p>
<p>そこで思いついたのが、「HTTPS サーバを Basic 認識ありの reverse proxy として使って Hexo server にアクセスする」という方法です。「いまさら Basic 認証？」と思われるかもしれませんが、これが意外と使えるのです。</p>
<ul>
<li>すべての Web ブラウザが対応している。</li>
<li>SSL/TLS で通信路を保護すれば認証情報も漏れない。</li>
<li>サーバ側の設定が簡単（セッション管理とか不要）。</li>
</ul>
<p>ポイントは、初回アクセスから常に HTTPS を使うことです。間違っても HTTP でアクセスしようとしてはいけません。認証情報が漏れてしまう危険があります。サーバ側の設定で、Basic 認証より先に HTTPS へのリダイレクトをすれば（HTTP リクエストに対して 401 じゃなくて 301 を返せば）大丈夫かもしれませんが、ブラウザの実装に依存しそうな気もするので、自信なし。サーバ側で HSTS を設定しておくか、80番ポートを閉じておくのが安心かも。</p>
<p>Hexo の設定（<code>_config.yml</code> ファイルの <code>url:</code> フィールドや <code>root:</code> フィールド）を変えたくないので、ブラウザからアクセスする際に指定する URL の path 部（スラッシュで始まる部分）として任意のパスを許容する必要があります。したがって、通常の HTTPS サーバとして使っているホスト名 (FQDN) とポート番号 (443/tcp) の少なくともどちらか一方を変えた URL を、その Hexo server 専用として用意する必要があります。ホスト名を変える場合は、使用する HTTP サーバが “virtual host” 機能 (SNI) に対応している必要があります。ポート番号を変える場合は、使用する HTTP サーバが受信ポートごとに異なるアクションを設定できる機能をもっている必要があります。ホスト名を変えると SSL 証明書を取り直さないといけなかったりして面倒なので、今回はポート番号を変えることにします。</p>

<h2 id="設定例"><a href="#設定例" class="headerlink" title="設定例"></a>設定例</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FQDN : www.example.com</div><div class="line">HTTPS 待ち受けポート : 8888/tcp</div><div class="line">Hexo server 待ち受けポート : 9999/tcp</div></pre></td></tr></table></figure>
<p>これまで Hexo server で使っていたポートがあるなら、それをそのまま HTTPS 待ち受けポートに流用するのが良いかもしれません。</p>

<h2 id="ファイアウォールの設定"><a href="#ファイアウォールの設定" class="headerlink" title="ファイアウォールの設定"></a>ファイアウォールの設定</h2>

<p>これまで Hexo server で使っていたポートをそのまま流用する場合、ファイアウォールの設定は変更不要です。</p>
<p>新たに HTTPS 待ち受けポートを用意する場合は、ファイアウォールでそのポートでの受信を許可します：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo ufw 8888 allow</div></pre></td></tr></table></figure>
<p>Hexo server の待ち受けポートは loopback アクセスのみ可能にしてください。<strong>外部からアクセス可能にしてはいけません</strong>。せっかくのセキュリティ強化が無意味になってしまいます。もし外部からアクセス可能な設定になっていたら、設定を変更してください：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo ufw 9999 deny</div></pre></td></tr></table></figure>

<h2 id="Web-サーバ-H2O-の設定"><a href="#Web-サーバ-H2O-の設定" class="headerlink" title="Web サーバ H2O の設定"></a>Web サーバ H2O の設定</h2>

<p>HTTPS サーバの設定と同じ設定にして、Listen するポート番号を 8888/tcp にします。</p>
<p><code>h2o.conf</code> の記述例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="attr">host:</span></div><div class="line">  <span class="string">"www.example.com:8888"</span><span class="string">:</span></div><div class="line"><span class="attr">    listen:</span></div><div class="line"><span class="attr">      port:</span> <span class="number">8888</span></div><div class="line"><span class="attr">      ssl:</span></div><div class="line"><span class="attr">        certificate-file:</span> <span class="string">path/to/server.crt</span></div><div class="line"><span class="attr">        key-file:</span> <span class="string">path/to/server.key</span></div><div class="line"><span class="attr">    paths:</span></div><div class="line">      <span class="string">"/"</span><span class="string">:</span></div><div class="line">        <span class="string">mruby.handler:</span> <span class="string">|</span></div><div class="line">          lambda do |env|</div><div class="line">            require "htpasswd.rb"</div><div class="line">            Htpasswd.new("/path/to/htpasswd", "Hexo server at 9999/tcp").call(env)</div><div class="line">          end</div><div class="line">        proxy.reverse.url: "http://127.0.0.1:9999/"</div></pre></td></tr></table></figure>
<p>注意点として、H2O で reverse proxy する接続先のホスト名としては、<code>localhost</code> ではなく <code>127.0.0.1</code> を指定してください。理由は、Hexo server が<strong>デフォルトでは IPv4 接続しか受け付けない</strong>からです。OS (Linux) の設定にも依存するのかもしれませんが、H2O で接続先を <code>http://localhost:9999/</code> のようにすると、コネクションごとに IPv4 で接続したり IPv6 で接続したりするようで、接続エラーになったりならなかったりします。H2O の error-log を見ると、一部のリクエストが “connection failed” となっていることが確認できます。ちなみに、H2O で接続先を <code>http://[::1]:9999/</code> とかにして IPv6 接続を強制すると、100% 接続エラーになります。</p>
<p>error-log の例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[lib/core/proxy.c] in request:/:connection failed</div><div class="line">[lib/core/proxy.c] in request:/favicon.ico:connection failed</div></pre></td></tr></table></figure>
<p>なお、Hexo server は、デフォルトでは <code>0.0.0.0</code> を Listen します（参考：<a href="https://github.com/hexojs/hexo-server/blob/master/index.js#L10" target="_blank" rel="external"><code>heso-server/index.js:10</code></a>）。つまり、サーバ上のすべてのインターフェースで IPv4 接続を受け付けます。<strong>IPv6 接続は受け付けません</strong>。Hexo server のヘルプ（下記）には “Bind to all IP address by default” と書かれていますが、実際には IPv4 限定です。Hexo server 起動時に明示的にコマンドラインオプションで <code>-i ::1</code> と指定すれば、IPv6 でのローカルループバック接続のみ受け付けるようになります（つまり、Hexo server 自体は IPv6 に対応しています）。もちろん、同様に <code>-i 127.0.0.1</code> と指定すれば、IPv4 でのローカルループバック接続のみ受け付けるようになります。そして、同様に <code>-i ::</code> と指定すると、<strong>IPv4 と IPv6 のどちらでも受け付けるようになりました</strong>（netstat コマンドで確認すると IPv6 しか Listen していないように見えるのですが、curl コマンドなどで試すと IPv4 でも IPv6 でも接続できました）。試した環境は Ubuntu 16.04.2 LTS (x86_64) と Hexo 3.3.7 の組み合わせです。</p>
<p><i>デフォルトで IPv6 接続も受け付けるようにするパッチを作る・・・・作りたい。そのうち。</i></p>
<p>参考）Hexo server のヘルプ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ hexo server --help</div><div class="line">Usage: hexo server</div><div class="line"></div><div class="line">Description:</div><div class="line">Start the server and watch for file changes.</div><div class="line"></div><div class="line">Options:</div><div class="line">  -i, --ip            Override the default server IP. Bind to all IP address by default.</div><div class="line">  -l, --log [format]  Enable logger. Override log format.</div><div class="line">  -o, --open          Immediately open the server url in your default web browser.</div><div class="line">  -p, --port          Override the default port.</div><div class="line">  -s, --static        Only serve static files.</div></pre></td></tr></table></figure>
<p>参考）デフォルト：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ hexo server -p 9999 &gt;log.txt 2&gt;&amp;1 &amp;</div><div class="line">$ netstat -antu | grep &apos;:9999&apos;</div><div class="line">tcp        0      0 0.0.0.0:9999            0.0.0.0:*               LISTEN</div><div class="line">$</div></pre></td></tr></table></figure>
<p>参考）IPv4 も IPv6 も接続可能なケース：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ hexo server -i :: -p 9999 &gt;log.txt 2&gt;&amp;1 &amp;</div><div class="line">$ netstat -antu | grep &apos;:9999&apos;</div><div class="line">tcp6       0      0 :::9999                 :::*                    LISTEN</div><div class="line">$</div></pre></td></tr></table></figure>
<p>参考）試した環境：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$ hexo -V</div><div class="line">hexo: 3.3.7</div><div class="line">hexo-cli: 1.0.3</div><div class="line">os: Linux 4.4.0-64-generic linux x64</div><div class="line">http_parser: 2.7.0</div><div class="line">node: 8.1.2</div><div class="line">v8: 5.8.283.41</div><div class="line">uv: 1.12.0</div><div class="line">zlib: 1.2.11</div><div class="line">ares: 1.10.1-DEV</div><div class="line">modules: 57</div><div class="line">openssl: 1.0.2l</div><div class="line">icu: 59.1</div><div class="line">unicode: 9.0</div><div class="line">cldr: 31.0.1</div><div class="line">tz: 2017b</div><div class="line">$</div><div class="line">$ cat /etc/lsb-release</div><div class="line">DISTRIB_ID=Ubuntu</div><div class="line">DISTRIB_RELEASE=16.04</div><div class="line">DISTRIB_CODENAME=xenial</div><div class="line">DISTRIB_DESCRIPTION=&quot;Ubuntu 16.04.2 LTS&quot;</div><div class="line">$</div></pre></td></tr></table></figure>
<p>あと、H2O が reverse proxy 接続する際に IPv4 接続と IPv6 接続を混在させてしまう理由は未調査です。H2O で <code>getaddrinfo(3)</code> あたりを呼んでいるコードを追えばわかりそうな気もしますが、未着手です。ちなみに、<code>/etc/hosts</code> には <code>127.0.0.1 localhost</code> と <code>::1 localhost</code> の両方が書いてあります。</p>

<h2 id="Hexo-server-の設定"><a href="#Hexo-server-の設定" class="headerlink" title="Hexo server の設定"></a>Hexo server の設定</h2>

<p>Hexo の設定（<code>_config.yml</code> ファイル）を変更する必要はありません。</p>
<p>Hexo server を起動するときに、IP address とポート番号を指定してあげるだけです：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ /usr/bin/nice -19 /usr/bin/ionice -c 3 hexo server -i 127.0.0.1 -p 9999 --debug</div></pre></td></tr></table></figure>

<h2 id="最後に確認"><a href="#最後に確認" class="headerlink" title="最後に確認"></a>最後に確認</h2>

<p>Web サーバに HTTPS 接続できることを確認します。手元のブラウザで <code>https://www.example.com:8888/</code> にアクセスしてみてください。Basic 認証が要求され、ユーザ名とパスワードを正しく入力すると、Hexo のコンテンツが表示されるはずです。無事にアクセスできたら、Web サーバのログにエラーが記録されていないことを確認してください。</p>
<p>念のため、Hexo server に直接アクセスできないことを確認します。手元のブラウザで（Hexo server を実行しているサーバ以外から） <code>http://www.example.com:9999/</code> にアクセスすると、ファイアウォールに弾かれて接続エラーになるハズです。なお、Hexo server を実行しているサーバ上で <code>curl</code> コマンドなどでアクセスすると、おそらく成功してしまいます（ファイアウォールはローカルループバック接続をデフォルトで許可していることが多いので）。</p>

      
    </div>
  </div>

</body>
</html>
